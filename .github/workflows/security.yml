name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: ['**']

env:
  SANDTRACE_VERSION: "0.1.0"

jobs:
  sandtrace-audit:
    name: Sandtrace Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install sandtrace
        run: |
          curl -sSfL "https://github.com/sandtrace/sandtrace/releases/download/v${SANDTRACE_VERSION}/sandtrace-v${SANDTRACE_VERSION}-x86_64-unknown-linux-gnu.tar.gz" -o sandtrace.tar.gz
          tar xzf sandtrace.tar.gz
          sudo mv sandtrace-v${SANDTRACE_VERSION}-x86_64-unknown-linux-gnu/sandtrace /usr/local/bin/
          rm -rf sandtrace.tar.gz sandtrace-v${SANDTRACE_VERSION}-x86_64-unknown-linux-gnu

      - name: Initialize sandtrace
        run: sandtrace init

      - name: Run audit (terminal)
        run: sandtrace audit . --severity medium

      - name: Run audit (SARIF)
        if: always()
        run: sandtrace audit . --format sarif --severity medium > sandtrace.sarif

      - name: Upload SARIF to GitHub Security
        if: always() && github.event_name == 'push'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sandtrace.sarif
          category: sandtrace

  sandtrace-scan:
    name: Sandtrace Obfuscation Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install sandtrace
        run: |
          curl -sSfL "https://github.com/sandtrace/sandtrace/releases/download/v${SANDTRACE_VERSION}/sandtrace-v${SANDTRACE_VERSION}-x86_64-unknown-linux-gnu.tar.gz" -o sandtrace.tar.gz
          tar xzf sandtrace.tar.gz
          sudo mv sandtrace-v${SANDTRACE_VERSION}-x86_64-unknown-linux-gnu/sandtrace /usr/local/bin/
          rm -rf sandtrace.tar.gz sandtrace-v${SANDTRACE_VERSION}-x86_64-unknown-linux-gnu

      - name: Run obfuscation scan
        run: sandtrace scan . --verbose
